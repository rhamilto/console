import { useState, useCallback } from 'react';
import * as _ from 'lodash';
import { useTranslation } from 'react-i18next';
import { useNavigate } from 'react-router-dom-v5-compat';
import { Modal, ModalHeader, ModalBody, Button, FormGroup, Form } from '@patternfly/react-core';
import { OverlayComponent } from '@console/dynamic-plugin-sdk/src/app/modal-support/OverlayProvider';
import { MachineAutoscalerModel } from '../../models';
import { NumberSpinner } from '../utils/number-spinner';
import { resourcePathFromModel } from '../utils/resource-link';
import { K8sResourceKind } from '../../module/k8s';
import { k8sCreateResource } from '@console/dynamic-plugin-sdk/src/utils/k8s';
import { usePromiseHandler } from '@console/shared/src/hooks/promise-handler';
import { ModalFooterWithAlerts } from '@console/shared/src/components/modals/ModalFooterWithAlerts';

export const ConfigureMachineAutoscalerModal: OverlayComponent<ConfigureMachineAutoscalerModalProps> = ({
  machineSet,
  closeOverlay,
  close,
  cancel: cancelProp,
}) => {
  const navigate = useNavigate();
  const [minReplicas, setMinReplicas] = useState(1);
  const [maxReplicas, setMaxReplicas] = useState(12);
  const [handlePromise, inProgress, errorMessage] = usePromiseHandler();

  const changeMinReplicas = (event) => {
    setMinReplicas(_.toInteger(event.target.value));
  };

  const changeMinReplicasBy = (operation) => {
    setMinReplicas(minReplicas + operation);
  };

  const changeMaxReplicas = (event) => {
    setMaxReplicas(_.toInteger(event.target.value));
  };

  const changeMaxReplicasBy = (operation) => {
    setMaxReplicas(maxReplicas + operation);
  };

  const createAutoscaler = useCallback((): Promise<K8sResourceKind> => {
    const {
      apiVersion,
      kind,
      metadata: { name, namespace },
    } = machineSet;

    const machineAutoscaler = {
      apiVersion: 'autoscaling.openshift.io/v1beta1',
      kind: 'MachineAutoscaler',
      metadata: {
        name,
        namespace,
      },
      spec: {
        minReplicas,
        maxReplicas,
        scaleTargetRef: {
          apiVersion,
          kind,
          name,
        },
      },
    };
    return k8sCreateResource({
      model: MachineAutoscalerModel,
      data: machineAutoscaler,
    });
  }, [machineSet, minReplicas, maxReplicas]);

  const submit = useCallback(
    (event): void => {
      event.preventDefault();
      // Use destructured close from props
      const promise = createAutoscaler();
      handlePromise(promise)
        .then((obj: K8sResourceKind) => {
          if (closeOverlay) {
            closeOverlay();
          } else if (close) {
            close();
          }
          navigate(
            resourcePathFromModel(
              MachineAutoscalerModel,
              obj.metadata.name,
              obj.metadata.namespace,
            ),
          );
        })
        .catch(() => {});
    },
    [createAutoscaler, handlePromise, navigate, closeOverlay, close],
  );

  const {
    metadata: { name },
  } = machineSet;
  const { t } = useTranslation();

  return (
    <Modal isOpen onClose={closeOverlay} variant="small">
      <ModalHeader
        title={t('public~Create MachineAutoscaler')}
        labelId="configure-machine-autoscaler-modal-title"
        description={t('public~This will automatically scale machine set {{ name }}.', { name })}
      />
      <ModalBody>
        <Form id="configure-machine-autoscaler-form">
          <FormGroup label={t('public~Minimum replicas:')} fieldId="min-replicas" isRequired>
            <NumberSpinner
              value={minReplicas}
              onChange={changeMinReplicas}
              changeValueBy={changeMinReplicasBy}
              autoFocus
              required
            />
          </FormGroup>
          <FormGroup label={t('public~Maximum replicas:')} fieldId="max-replicas" isRequired>
            <NumberSpinner
              value={maxReplicas}
              onChange={changeMaxReplicas}
              changeValueBy={changeMaxReplicasBy}
              required
            />
          </FormGroup>
        </Form>
      </ModalBody>
      <ModalFooterWithAlerts errorMessage={errorMessage}>
        <Button
          variant="primary"
          isLoading={inProgress}
          onClick={submit}
          form="configure-machine-autoscaler-form"
        >
          {t('public~Create')}
        </Button>
        <Button variant="link" onClick={closeOverlay || cancelProp} type="button">
          {t('public~Cancel')}
        </Button>
      </ModalFooterWithAlerts>
    </Modal>
  );
};

type ConfigureMachineAutoscalerModalProps = {
  machineSet: K8sResourceKind;
  cancel?: () => void;
  close?: () => void;
};
