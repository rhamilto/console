/* eslint-disable tsdoc/syntax */ // This file is written in JavaScript, so we use JSDoc here. TSDoc rules don't apply
// @ts-check
// Register ts-node to handle TypeScript imports before Jest's module system is active
require('ts-node').register({
  transpileOnly: true,
  compilerOptions: { module: 'commonjs' },
});

const { getLocalPluginsModuleData } = require('@console/plugin-sdk/src/codegen/local-plugins');
const { resolvePluginPackages } = require('@console/plugin-sdk/src/codegen/plugin-resolver');

/** @type {import('@jest/transform').SyncTransformer} */
module.exports = {
  /** @returns unique cache key every run to disable caching */
  getCacheKey() {
    return Date.now().toString();
  },

  /** @returns the code typically generated by get-local-plugins.js but in CJS module format */
  process(src, filename) {
    // Only transform the get-local-plugins.js module
    if (!filename.endsWith('get-local-plugins.js')) {
      return { code: src };
    }

    const pluginPackages = resolvePluginPackages();
    const { code, diagnostics } = getLocalPluginsModuleData(pluginPackages, 'cjs');

    if (diagnostics.errors.length > 0) {
      // eslint-disable-next-line no-console
      console.error('Local plugins module errors:', diagnostics.errors);
    }

    return { code };
  },
};
